{% extends 'base.html' %}

{% block title %}{% if is_edit %}Edit Project - SiteSphere{% else %}Create Project - SiteSphere{% endif %}{% endblock %}

{% block page_title %}{% if is_edit %}Edit Project{% else %}Create New Project{% endif %}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <form method="post" id="projectForm">
            {% csrf_token %}
            
            <!-- Project Information -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Project Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ project_form.name.id_for_label }}" class="form-label fw-semibold">Project Name *</label>
                            {{ project_form.name }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ project_form.company_name.id_for_label }}" class="form-label fw-semibold">Company Name *</label>
                            {{ project_form.company_name }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ project_form.description.id_for_label }}" class="form-label fw-semibold">Project Description</label>
                        {{ project_form.description }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ project_form.project_address.id_for_label }}" class="form-label fw-semibold">Project Address *</label>
                        {{ project_form.project_address }}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ project_form.start_date.id_for_label }}" class="form-label fw-semibold">Start Date *</label>
                            {{ project_form.start_date }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ project_form.end_date.id_for_label }}" class="form-label fw-semibold">End Date</label>
                            {{ project_form.end_date }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ project_form.status.id_for_label }}" class="form-label fw-semibold">Status</label>
                            {{ project_form.status }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ project_form.estimated_budget.id_for_label }}" class="form-label fw-semibold">Estimated Budget (₹) *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                {{ project_form.estimated_budget }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Partners Information -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Project Partners
                    </h5>
                    <button type="button" class="btn btn-light btn-sm" id="addPartner">
                        <i class="fas fa-plus me-1"></i>
                        Add Partner
                    </button>
                </div>
                <div class="card-body">
                    <div id="partnerFormset">
                        {{ partner_formset.management_form }}
                        {% for form in partner_formset %}
                        <div class="partner-form border rounded p-3 mb-3" style="background-color: #f8f9fa;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-primary mb-0">
                                    <i class="fas fa-user me-2"></i>
                                    Partner {{ forloop.counter }}
                                </h6>
                                {% if not forloop.first %}
                                <button type="button" class="btn btn-outline-danger btn-sm remove-partner">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Partner Name *</label>
                                    {{ form.name }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label fw-semibold">Date of Birth *</label>
                                    {{ form.date_of_birth }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label fw-semibold">Proportion (%) *</label>
                                    <div class="input-group">
                                        {{ form.proportion }}
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Address *</label>
                                {{ form.address }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Phone Number *</label>
                                    {{ form.phone_number }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Email</label>
                                    {{ form.email }}
                                </div>
                            </div>
                            
                            <!-- Hidden fields for formset -->
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Partner ages will be automatically calculated based on their date of birth. Ensure all proportion percentages add up to 100%.
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="card">
                <div class="card-body text-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5 me-3">
                        <i class="fas fa-save me-2"></i>
                        {% if is_edit %}Update Project{% else %}Create Project{% endif %}
                    </button>
                    <a href="{% url 'dashboard:project_selection' %}" class="btn btn-outline-secondary btn-lg px-5">
                        <i class="fas fa-times me-2"></i>
                        Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let partnerCount = {{ partner_formset.total_form_count }};
    const maxForms = {{ partner_formset.max_num }};
    
    // Add partner functionality
    document.getElementById('addPartner').addEventListener('click', function() {
        if (partnerCount < maxForms) {
            const formsetDiv = document.getElementById('partnerFormset');
            const totalForms = document.getElementById('id_partners-TOTAL_FORMS');
            
            // Clone the first partner form
            const firstForm = document.querySelector('.partner-form');
            const newForm = firstForm.cloneNode(true);
            
            // Update form indices
            const formRegex = new RegExp('partners-0-', 'g');
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `partners-₹{partnerCount}-`);
            
            // Clear form values
            const inputs = newForm.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type !== 'hidden') {
                    input.value = '';
                }
            });
            
            // Update partner number
            const partnerHeader = newForm.querySelector('h6');
            partnerHeader.innerHTML = `<i class="fas fa-user me-2"></i>Partner ₹{partnerCount + 1}`;
            
            // Add remove button if it doesn't exist
            const removeBtn = newForm.querySelector('.remove-partner');
            if (!removeBtn) {
                const headerDiv = newForm.querySelector('.d-flex');
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'btn btn-outline-danger btn-sm remove-partner';
                removeButton.innerHTML = '<i class="fas fa-trash"></i>';
                headerDiv.appendChild(removeButton);
            }
            
            // Insert before the management form
            const managementForm = document.querySelector('[name="partners-TOTAL_FORMS"]').closest('input');
            formsetDiv.insertBefore(newForm, managementForm);
            
            partnerCount++;
            totalForms.value = partnerCount;
            
            // Add event listener to new remove button
            newForm.querySelector('.remove-partner').addEventListener('click', removePartner);
        }
    });
    
    // Remove partner functionality
    function removePartner(e) {
        const partnerForm = e.target.closest('.partner-form');
        partnerForm.remove();
        partnerCount--;
        document.getElementById('id_partners-TOTAL_FORMS').value = partnerCount;
        
        // Update partner numbers
        const partnerForms = document.querySelectorAll('.partner-form');
        partnerForms.forEach((form, index) => {
            const header = form.querySelector('h6');
            header.innerHTML = `<i class="fas fa-user me-2"></i>Partner ₹{index + 1}`;
        });
    }
    
    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-partner').forEach(btn => {
        btn.addEventListener('click', removePartner);
    });
    
    // Form validation
    document.getElementById('projectForm').addEventListener('submit', function(e) {
        const proportions = document.querySelectorAll('[name*="proportion"]');
        let totalProportion = 0;
        
        proportions.forEach(input => {
            if (input.value) {
                totalProportion += parseFloat(input.value);
            }
        });
        
        if (totalProportion > 100) {
            e.preventDefault();
            alert('Total partner proportions cannot exceed 100%');
        }
    });
});
</script>
{% endblock %}